<!DOCTYPE html>
<html lang="pt">
<head>
    <script>
        carregarTotem = window.location.search
        carregarTotem = carregarTotem.substring(1, carregarTotem.length)
    </script>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
    <title>Mapas | Dashboard</title>
</head>
<body>
    <div id="botoesMapa"></div>
    <div id="teste" style="width: 600px; transition: 1000ms;">
        <p id="map" style="height: 400px;"></p>
    </div>
</body>
</html>
<script>
    function criarMapa(cords) {
        // Preparar mapa escolhido e botões de seleção
        const cordsOriginais = cords
        if (carregarTotem == "totens") {
            totemAtual = "Atual - "
        } else {
            totemAtual = ""
        }
        botoesMapa.innerHTML = `<a href="mapaDash.html?totens">${totemAtual}Todos os Totens</a>`
        totemAtual = ""
        for (i = 0; i < cordsOriginais.length; i ++) {
            if (cordsOriginais[i].fkTotem == carregarTotem) {
                cords = [cords[i]]
                totemAtual = "Atual - "
            } else {
                totemAtual = ""
            }
            botoesMapa.innerHTML += `<br><a href="mapaDash.html?${cordsOriginais[i].fkTotem}">${totemAtual}Totem ${cordsOriginais[i].fkTotem}</a>`
            totemAtual = ""
        }

        // Decidir centro do mapa com base na localização dos pontos carregados
        if (cords.length > 1) {
            centro = []
            for (i = 0; i < cords.length; i++) {
                console.log(cords[i])
                centro.push([cords[i].latitude, cords[i].longitude])
            }
            centroMapa = L.polygon(centro).getBounds().getCenter()
        } else {
            centroMapa = {lat: cords[0].latitude, lng: cords[0].longitude}
        }

        // Calculando distância entre o centro do mapa e todos os pontos e salvando o mais distante deles
        maiorDistancia = 0
        for (i = 0; i < cords.length; i++) {
            if (centroMapa.lat >= cords[i].latitude) {deltaY = centroMapa.lat - cords[i].latitude} else {deltaY = cords[i].latitude - centroMapa.lat}
            if (centroMapa.lng >= cords[i].longitude) {deltaX = centroMapa.lng - cords[i].longitude} else {deltaX = cords[i].longitude - centroMapa.lng}
            distancia = ((deltaY**2) + (deltaX**2))**1/2
            if (distancia > maiorDistancia) {
                maiorDistancia = distancia
            }
        }
        console.log(`Maior distância a partir do centro: ${maiorDistancia}`)

        // Definindo o zoom a partir da distância entre o ponto central e o mais longe
        // TODO: Depois do front configurar direito isso aqui
        if (maiorDistancia >= 0) {
            zoomMapa = 15
            if (maiorDistancia > 0) {
                zoomMapa = 10
                if (maiorDistancia > 0.130) {
                    zoomMapa = 9
                    if (maiorDistancia > 0.375) {
                        zoomMapa = 8
                        if (maiorDistancia > 1.375) {
                            zoomMapa = 3
                            if (maiorDistancia > 22000) {
                                zoomMapa = 1
                            }
                        }
                    }
                }
            }
        }

        // Começando a realmente carregar o mapa com a API Leaflet
        var LeafIcon = L.Icon.extend({
            options: {
                iconSize: [50, 50],
                iconAnchor: [24, 50]
            }
        })
        var map = L.map('map').setView([centroMapa.lat, centroMapa.lng], zoomMapa)
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map)
        for (i = 0; i < cords.length; i++) {
            L.marker([cords[i].latitude, cords[i].longitude], {icon: new LeafIcon({iconUrl: "./assets/img/totemAeroporto.png"})}).addTo(map)
            L.circle([cords[i].latitude, cords[i].longitude], {
                color: '#0087ff',
                fillColor: '#0bc9f4',
                fillOpacity: 0.2,
                radius: cords[i].precisao,
            }).addTo(map)
        }
    }

    fetch(`/medidas/static-mapas`, {
        method: "GET"
    }).then(function (response) {
        if (response.ok) {
            response.json().then(function (resposta) {
                criarMapa(resposta)
            })
        }
    })
</script>