<!DOCTYPE html>
<html lang="pt">

<head>
  <script>
    // Pegando a queryString da página
      carregarTotem = window.location.search
      carregarTotem = carregarTotem.substring(1, carregarTotem.length)
  </script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="apple-touch-icon" sizes="76x76" href="assets/img/icon-ekran.png">
  <link rel="icon" type="image/png" href="assets/img/icon-ekran.png">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
    <title>
    ēKran - Mapas
  </title>
  <link href="https://fonts.googleapis.com/css?family=Poppins:200,300,400,600,700,800" rel="stylesheet"/>
  <link href="https://use.fontawesome.com/releases/v5.0.6/css/all.css" rel="stylesheet">
  <!-- Nucleo Icons -->
  <link href="assets/css/nucleo-icons.css" rel="stylesheet">
  <!-- CSS Files -->
  <link rel="stylesheet" href="assets/css/black-dashboard.css?v=1.0.0">
  <!-- CSS Just for demo purpose, don't include it in your project -->
  <link href="assets/demo/demo.css" rel="stylesheet">
  <!-- Script para o modal do alert -->
  <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
  <div class="wrapper">
    <div class="sidebar">
      <div class="sidebar-wrapper">
        <div class="logo">
          <a href="javascript:void(0)" class="simple-text logo-mini">
            <i class="tim-icons icon-chart-bar-32"></i>
          </a>
          <a href="javascript:void(0)" class="simple-text logo-normal">
            ēKran
          </a>
        </div>
        <ul class="nav">
          <li>
            <a href="dashboardTeste.html">
              <i class="tim-icons icon-app"></i>
              <p>Geral</p>
            </a>
          </li>
          <li>
            <a href="totem1.html">
              <i class="tim-icons icon-chart-pie-36"></i>
              <p>Totem 1</p>
            </a>
          </li>
          <li>
            <a href="totem2.html">
              <i class="tim-icons icon-chart-pie-36"></i>
              <p>Totem 2</p>
            </a>
          </li>
          <li>
            <a href="totem3.html">
              <i class="tim-icons icon-chart-pie-36"></i>
              <p>Totem 3</p>
            </a>
          </li>
          <li>
            <a href="dash_seguranca.html">
              <i class="tim-icons icon-lock-circle"></i>
              <p>Segurança</p>
            </a>
          </li>
          <li>
            <a href="dashProcessos.html">
              <i class="tim-icons icon-single-copy-04"></i>
              <p>Processos</p>
            </a>
          <li>
            <a href="tables.html?diario">
              <i class="tim-icons icon-single-copy-04"></i>
              <p>Histórico</p>
            </a>
          </li>
          <li>
            <a href="funcionario.html">
              <i class="tim-icons icon-badge"></i>
              <p>Cadastrar funcionário</p>
            </a>
          </li>
          <li class="active">
            <a href="mapaDash.html?totens">
              <i class="tim-icons icon-square-pin"></i>
              <p>Mapas</p>
            </a>
          </li>
          <li>
            <a href="unidade.html">
              <i class="tim-icons icon-square-pin"></i>
              <p>Cadastrar unidade</p>
            </a>
          </li>
          <li>
            <a href="https://app.pipefy.com/public/form/JBbirBal">
              <i class="tim-icons icon-headphones"></i>
              <p>Suporte</p>
            </a>
          </li>
          <li>
            <a href="index.html">
              <i class="tim-icons icon-double-left"></i>
              <p>Sair</p>
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="main-panel">
      <!-- Navbar -->
      <nav class="navbar navbar-expand-lg navbar-absolute navbar-transparent">
        <div class="container-fluid">
          <div class="navbar-wrapper">
            <div class="navbar-toggle d-inline">
              <button type="button" class="navbar-toggler">
                <span class="navbar-toggler-bar bar1"></span>
                <span class="navbar-toggler-bar bar2"></span>
                <span class="navbar-toggler-bar bar3"></span>
              </button>
            </div>
            <a class="navbar-brand" id="totem" href="javascript:void(0)">Dashboard - Mapas</a>
          </div>
          <div class="collapse navbar-collapse" id="navigation">
            <ul class="navbar-nav ml-auto">
              <li class="search-bar input-group">
              </li>
              <li class="dropdown nav-item">
              </li>
              <li class="dropdown nav-item">
              </li>
              <li class="separator d-lg-none"></li>
            </ul>
          </div>
        </div>
      </nav>
      <div class="modal modal-search fade" id="searchModal" tabindex="-1" role="dialog" aria-labelledby="searchModal"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
        </div>
      </div>
      <div class="content" id="paginaMaior">
        <div class="row">
          <div class="col-12">
            <div class="card card-chart">
              <div class="card-header" style="height: 500px;">
                <div class="postcard">
                    <div class="postcardPlaceholder">
                        <div class="postcardInner">
                            <div class="postcardFront">
                              <div id=""></div>
                                <span id="botoesMapa" style="color: white;"><span style="font-size: 200%; font-weight: bold;">CARREGANDO</span></span>
                                <img src="./assets/img/map-icon.png" height="40%" width="20%">
                            </div>
                            <div class="postcardBack">
                                <button onclick="virar(false)" class="postcardBtn">Visualizar todos os Totens</button>
                                <div id="map" style="width: 1100px; height: 475px; z-index: 1;"></div>
                            </div>
                        </div>
                    </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="row" style="display: none;" id="aparecerTotem">
          <div class="col-lg-6 col-md-12">
            <div class="card card-tasks">
              <div style="display: flex; align-items: center; justify-content: center; flex-direction: column; height:100%; width:100%">
                <span style="margin-top: 5%; font-size: 200%; color: white; display: flex;">Temperatura do Totem <img src="./assets/img/letter_i_PNG11.png" width="25px" height="25px" style="margin-left: 10px; margin-top: 8px;"></span>
                <span style="color: white;">Média diária em °C</span>
                <div style="padding: 2%; height:95%; width:95%;">
                  <canvas id="graficoTestes" style="position: relative; height:100%; width:100%"></canvas>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-6 col-md-12">
            <div class="card card-tasks">
              <div style="display: flex; align-items: center; justify-content: center; flex-direction: column; height:100%; width:100%">
                <span style="margin-top: 5%; font-size: 200%; color: white; display: flex;">Temperatura da Região <img src="./assets/img/letter_i_PNG11.png" width="25px" height="25px" style="margin-left: 10px; margin-top: 8px;"></span>
                <span style="color: white;">Média diária em °C</span>
                <div style="padding: 20px; height:95%; width:95%;">
                  <canvas id="graficoLinhas" style="position: relative; height:100%; width:100%"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>
        <script>if(carregarTotem!='totens'){aparecerTotem.style.display="flex"}</script>
      </div>
  </div>
  <!-- SIDE BAR -->
  <div class="fixed-plugin">
    <div class="dropdown show-dropdown">
      <a href="#" data-toggle="dropdown">
        <i class="fa fa-cog fa-2x"> </i>
      </a>
      <ul class="dropdown-menu">
        <li class="header-title"> FUNDO </li>
        <li class="adjustments-line">
          <a href="javascript:void(0)" class="switch-trigger background-color">
            <div class="badge-colors text-center">
              <span class="badge filter badge-primary active" data-color="primary"></span>
              <span class="badge filter badge-info" data-color="blue"></span>
              <span class="badge filter badge-success" data-color="dark"></span>
            </div>
            <div class="clearfix"></div>
          </a>
        </li>
        <li class="adjustments-line text-center color-change">
          <span class="color-label">MODO CLARO</span>
          <span class="badge light-badge mr-2"></span>
          <span class="badge dark-badge ml-2"></span>
          <span class="color-label">MODO ESCURO</span>
        </li>
      </ul>
    </div>
  </div>
  <script src="assets/js/core/jquery.min.js"></script>
  <script src="assets/js/core/popper.min.js"></script>
  <script src="assets/js/core/bootstrap.min.js"></script>
  <script src="assets/js/plugins/perfect-scrollbar.jquery.min.js"></script>
  <script src="assets/js/plugins/chartjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="assets/js/plugins/bootstrap-notify.js"></script>
  <script src="assets/js/black-dashboard.min.js?v=1.0.0"></script>
  <script src="assets/demo/demo.js"></script>
  
  <script>
    $(document).ready(function () {
      $().ready(function () {
        $sidebar = $('.sidebar');
        $navbar = $('.navbar');
        $main_panel = $('.main-panel');

        $full_page = $('.full-page');

        $sidebar_responsive = $('body > .navbar-collapse');
        sidebar_mini_active = true;
        white_color = false;

        window_width = $(window).width();

        fixed_plugin_open = $('.sidebar .sidebar-wrapper .nav li.active a p').html();



        $('.fixed-plugin a').click(function (event) {
          if ($(this).hasClass('switch-trigger')) {
            if (event.stopPropagation) {
              event.stopPropagation();
            } else if (window.event) {
              window.event.cancelBubble = true;
            }
          }
        });

        $('.fixed-plugin .background-color span').click(function () {
          $(this).siblings().removeClass('active');
          $(this).addClass('active');

          var new_color = $(this).data('color');

          if ($sidebar.length != 0) {
            $sidebar.attr('data', new_color);
          }

          if ($main_panel.length != 0) {
            $main_panel.attr('data', new_color);
          }

          if ($full_page.length != 0) {
            $full_page.attr('filter-color', new_color);
          }

          if ($sidebar_responsive.length != 0) {
            $sidebar_responsive.attr('data', new_color);
          }
        });

        $('.switch-sidebar-mini input').on("switchChange.bootstrapSwitch", function () {
          var $btn = $(this);

          if (sidebar_mini_active == true) {
            $('body').removeClass('sidebar-mini');
            sidebar_mini_active = false;
            blackDashboard.showSidebarMessage('Sidebar mini deactivated...');
          } else {
            $('body').addClass('sidebar-mini');
            sidebar_mini_active = true;
            blackDashboard.showSidebarMessage('Sidebar mini activated...');
          }

          // we simulate the window Resize so the charts will get updated in realtime.
          var simulateWindowResize = setInterval(function () {
            window.dispatchEvent(new Event('resize'));
          }, 180);

          // we stop the simulation of Window Resize after the animations are completed
          setTimeout(function () {
            clearInterval(simulateWindowResize);
          }, 1000);
        });

        $('.switch-change-color input').on("switchChange.bootstrapSwitch", function () {
          var $btn = $(this);

          if (white_color == true) {

            $('body').addClass('change-background');
            setTimeout(function () {
              $('body').removeClass('change-background');
              $('body').removeClass('white-content');
            }, 900);
            white_color = false;
          } else {

            $('body').addClass('change-background');
            setTimeout(function () {
              $('body').removeClass('change-background');
              $('body').addClass('white-content');
            }, 900);

            white_color = true;
          }


        });

        $('.light-badge').click(function () {
          $('body').addClass('white-content');
        });

        $('.dark-badge').click(function () {
          $('body').removeClass('white-content');
        });
      });
    });
  </script>
</body>
</script>
</html>
<script>
  //tudo que realmente importa
  tempoTimeout = 0

  function virar(virado) {
    const classePostcardInner = document.querySelector('.postcardInner')
    if (virado == true) {
        classePostcardInner.classList.add('virado')
    } else if (virado == false) {
        classePostcardInner.classList.remove('virado')
    }
  }
  function criarMapa(cords, mediasCores) {
    // Preparar mapa escolhido e botões de seleção
    const cordsOriginais = cords
    texto = ""
    if (carregarTotem == "totens") {
        totemAtual = " style='background-color: #1498ff;"
    } else {
        totemAtual = " style='background-color: #0061ad;"
    }
    texto = `<button onclick="location.href='mapaDash.html?totens'"${totemAtual} margin: 1px; width: 140px; height: 35px; border: 1px solid black; border-radius: 5px; color: white; font-weight: bold;'>Todos os Totens</button>`
    totemAtual = ""
    for (i = 0; i < cordsOriginais.length; i ++) {
        if (cordsOriginais[i].fkTotem == carregarTotem) {
            cords = [cords[i]]
            totemAtual = " style='background-color: #1498ff;"
        } else {
            totemAtual = " style='background-color: #0061ad;"
        }
        if (i % 2 == 0) {
          texto += "<div style='display: flex;'>"
        }
        texto += `<button onclick="location.href='mapaDash.html?${cordsOriginais[i].fkTotem}'"${totemAtual} margin: 1px; width: 125px; height: 40px; border: 1px solid black; border-radius: 5px; color: white; font-size: 150%; font-weight: bold;'>Totem ${cordsOriginais[i].fkTotem-49999}</button>`
        totemAtual = " style='background-color: #0061ad;"
        if (!(i % 2 == 0)) {
          texto += "</div>"
        }
    }


    // Decidir centro do mapa com base na localização dos pontos carregados
    if (cords.length > 1) {
        centro = []
        for (i = 0; i < cords.length; i++) {
            centro.push([cords[i].latitude, cords[i].longitude])
        }
        centroMapa = L.polygon(centro).getBounds().getCenter()
    } else {
        centroMapa = {lat: cords[0].latitude, lng: cords[0].longitude}
    }

    // Calculando distância entre o centro do mapa e todos os pontos e salvando o mais distante deles
    maiorDistancia = 0
    for (i = 0; i < cords.length; i++) {
        if (centroMapa.lat >= cords[i].latitude) {deltaY = centroMapa.lat - cords[i].latitude} else {deltaY = cords[i].latitude - centroMapa.lat}
        if (centroMapa.lng >= cords[i].longitude) {deltaX = centroMapa.lng - cords[i].longitude} else {deltaX = cords[i].longitude - centroMapa.lng}
        distancia = ((deltaY**2) + (deltaX**2))**1/2
        if (distancia > maiorDistancia) {
            maiorDistancia = distancia
        }
    }
    
    // Definindo o zoom a partir da distância entre o ponto central e o mais longe
    // TODO: Depois do front configurar direito isso aqui
    console.log(`Maior distância a partir do centro: ${maiorDistancia}`)
    if (maiorDistancia >= 0) {
        zoomMapa = 18
        if (maiorDistancia > 0) {
            zoomMapa = 12
            if (maiorDistancia > 0.130) {
                zoomMapa = 9
                if (maiorDistancia > 0.375) {
                    zoomMapa = 8
                    if (maiorDistancia > 1.375) {
                        zoomMapa = 5
                        if (maiorDistancia > 22000) {
                            zoomMapa = 1
                        }
                    }
                }
            }
        }
    }

    // Começando a realmente carregar o mapa com a API Leaflet
    var LeafIcon = L.Icon.extend({
        options: {
            iconSize: [50, 50],
            iconAnchor: [24, 50]
        }
    })

    var map = L.map('map').setView([centroMapa.lat, centroMapa.lng], zoomMapa)
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map)
    for (i = 0; i < cords.length; i++) {
      if (carregarTotem != 'totens') {
        plotarClimaTempo(cords[i].latitude, cords[i].longitude)
      }
      mediaAtual = ""
      for (f = 0; f < mediasCores.length; f++) {
        if (mediasCores[f].fkTotem == cords[i].fkTotem) {
          mediaAtual = mediasCores[f].media
          if (mediaAtual <= 10) {
            icone = "A"
          } else if (mediaAtual <= 25) {
            icone = "B"
          } else if (mediaAtual >= 80) {
            icone = "E"
          } else if (mediaAtual >= 70) {
            icone = "D"
          } else {
            icone = "C"
          }
        }
      }
      L.marker([cords[i].latitude, cords[i].longitude], {icon: new LeafIcon({iconUrl: `./assets/img/totemAeroporto${icone}.png`})}
      ).addTo(map)
      .bindPopup(`<b>Nome do Totem:</b><br>Totem ${cords[i].fkTotem-49999}<br><b>ID do Totem:</b><br>${cords[i].fkTotem}<br><b>Latitude:</b><br>${cords[i].latitude}°<br><b>Longitude:</b><br>${cords[i].longitude}°<br><b>Precisão da coleta:</b><br>${cords[i].precisao}m<br><b>Média de Temperatura do dia:</b><br>${mediaAtual} °C<br><b>Data da coleta:</b><br>${cords[i].dia}<br><b>Horário da coleta:</b><br>${cords[i].hora}<br><b>ID da Unidade:</b><br>${cords[i].idUnidade}`)
      L.circle([cords[i].latitude, cords[i].longitude], {
          color: '#3bd22d',
          fillColor: '#11ee24',
          fillOpacity: 0.2,
          radius: cords[i].precisao,
      }).addTo(map)
    }

    // Vejo todas as unidades cadastradas
    unidades = []
    for (i = 0; i < cords.length; i++) {
        taAqui = false
        for (f = 0; f < unidades.length; f++) {
            if (unidades[f].idUnidade == cords[i].idUnidade) {
                taAqui = true
            }
        }
        if (!taAqui) {
            unidades.push(cords[i])
        }
    }

    // Utilizo essa informação para plotar polígonos no mapa que envolvem todos os totens
    for (i = 0; i < unidades.length; i++) {
        cordsPoligono = []
        for (f = 0; f < cords.length; f++) {
            if (cords[f].idUnidade == unidades[i].idUnidade) {
                cordsPoligono.push([cords[f].latitude, cords[f].longitude])
            }
        }
        L.polygon(cordsPoligono).addTo(map)
        .bindPopup(`<b>Nome da Empresa:</b><br>${unidades[i].nomeEmpresa}<br><b>Local da Unidade:</b><br>${unidades[i].localUnidade}<br><b>ID da Unidade:</b><br>${unidades[i].idUnidade}`)
    }

    // Faço o mapa aparecer após o loading
    virar(true)
    setTimeout(() => {
        botoesMapa.innerHTML = texto
    }, "300")
  }

  fetch(`/medidas/static-mapas`, {
      method: "GET"
  }).then(function (response) {
      if (response.ok) {
          response.json().then(function (resposta) {
            var v1 = resposta
            fetch(`/medidas/checarMediasTempTotens`, {
                method: "GET"
            }).then(function (response) {
                if (response.ok) {
                    response.json().then(function (resposta) {
                      var v2 = resposta
                      criarMapa(v1, v2)
                    })
                }
            })
          })
      }
  })
  
  // Temperatura do Totem - Média diária

  function plotarTempTotem(resposta) {
    datasNecessitadas = []
    for (i = 0; i < 5; i++) {
      dataa = new Date(Date.now() - i * 24 * 60 * 60 * 1000)
      if (String(dataa.getDate()).length == 1) {
        dia = `0${dataa.getDate()}`
      } else {
        dia = String(dataa.getDate())
      }
      datasNecessitadas.push(`${String(dataa.getFullYear())}/${String(dataa.getMonth()+1)}/${dia}`)
    }
    valoresUsaveis = []
    for (i = 0; i < resposta.length; i++) {
      if (resposta[i].fkTotem == carregarTotem) {
        valoresUsaveis.push(resposta[i])
      }
    }
    valoresDoGrafico = []
    for (i = 0; i < datasNecessitadas.length; i++) {
      for (f = 0; f < valoresUsaveis.length; f++) {
        if (datasNecessitadas[i] == valoresUsaveis[f].dia) {
          valoresDoGrafico.push([valoresUsaveis[f].minimo, valoresUsaveis[f].valor, valoresUsaveis[f].maximo])
          break
        }
      }
      if (valoresDoGrafico.length != i+1) {
        valoresDoGrafico.push([null, null, null])
      }
    }
    valoresDoGrafico = valoresDoGrafico.reverse()
    datasNecessitadasArray = datasNecessitadas.reverse()
    datasNecessitadas = []
    for (i = 0; i < datasNecessitadasArray.length; i++) {
      datasNecessitadas.push(`${datasNecessitadasArray[i].substring(8)}/${datasNecessitadasArray[i].substring(5,7)}`)
    }
    datasets = []
    dados1 = []
    for (i = 0; i < 3; i++) {
      if (i == 0) {
        labela = 'Mínimo'
        backgroundColora = '#3DA4C2'
        borderColora = '#1EC1E1'
      } else if (i == 1) {
        labela = 'Média'
        backgroundColora = '#fff8ff'
        borderColora = '#ecf2f0'
      } else if (i == 2) {
        labela = 'Máximo'
        backgroundColora = '#D6292C'
        borderColora = '#D03A2F'
      }
      dados = []
      for (f = 0; f < valoresDoGrafico.length; f++) {
        dados.push(valoresDoGrafico[f][i])
      }
      datasets.push({label: labela, backgroundColor: backgroundColora, borderColor: borderColora, data: dados})
      dados1.push(dados)
    }
    chamarGrafico(dados1, "primeiro")
    Chart.defaults.color = '#fff'
    new Chart(
      graficoTestes,
      {
          type: 'line',
          data:
          {
              labels: datasNecessitadas,
              datasets: datasets
          },
          options: {}
      }
    )
  }
  if (carregarTotem != 'totens') {
    fetch("/medidas/temp-comparativa-mapas", {
        method: "GET"
    }).then(function (response) {
        if (response.ok) {
            response.json().then(function (resposta) {
              plotarTempTotem(resposta)
            })
        }
    })
  }

  /*
  ====================================
  Temperatura da Região - Média diária
  ====================================
  */

  // Aqui eu desativo minha API
  visualCrossingInativo = true

  function plotarVisualCrossing(resposta) {
    for (i = 0; i < resposta.days.length; i++) {
      respostaFinal.push([((resposta.days[i].tempmin - 32) / 9) * 5, ((resposta.days[i].temp - 32) / 9) * 5, ((resposta.days[i].tempmax - 32) / 9) * 5, resposta.days[i].datetime])
    }
    const data = {
      labels: [],
      datasets: []
    }
    for (i = 0; i < respostaFinal.length; i++) {
      data.labels.push(`${respostaFinal[i][3].substring(8,10)}/${respostaFinal[0][3].substring(5,7)}`)
    }
    dados2 = []
    for (i = 0; i < 3; i++) {
      if (i == 0) {
        labela = 'Mínimo'
        backgroundColora = '#3DA4C2'
        borderColora = '#1EC1E1'
      } else if (i == 1) {
        labela = 'Média'
        backgroundColora = '#fff8ff'
        borderColora = '#ecf2f0'
      } else if (i == 2) {
        labela = 'Máximo'
        backgroundColora = '#D6292C'
        borderColora = '#D03A2F'
      }

      data.datasets.push({label: labela, backgroundColor: backgroundColora, borderColor: borderColora, data: [respostaFinal[0][i], respostaFinal[1][i], respostaFinal[2][i], respostaFinal[3][i], respostaFinal[4][i]]})
      dados2.push([respostaFinal[0][i], respostaFinal[1][i], respostaFinal[2][i], respostaFinal[3][i], respostaFinal[4][i]])
    }
    chamarGrafico(dados2, "segundo")
    Chart.defaults.color = '#fff'
    new Chart(
      graficoLinhas,
      {
          type: 'line',
          data: data,
          options: {}
      }
    )
  }

  dataa = new Date()
  dataFinal = `${String(dataa.getFullYear())}-${String(dataa.getMonth()+1)}-${dataa.getDate()}`
  dataa = new Date(Date.now() - 4 * 24 * 60 * 60 * 1000)
  dataInicial = `${String(dataa.getFullYear())}-${String(dataa.getMonth()+1)}-${dataa.getDate()}`
  respostaFinal = []
  function plotarClimaTempo(lat, lng) {
    if (visualCrossingInativo) {
      plotarVisualCrossing({
        address: "-23.5429886,-46.7575315",
        days: [{
          datetime: "2022-11-27",
          tempmin: 60.6,
          temp: 67.5,
          tempmax: 78.2
        }, {
          datetime: "2022-11-28",
          tempmin: 63,
          temp: 66.7,
          tempmax: 77.9
        }, {
          datetime: "2022-11-29",
          tempmin: 64.3,
          temp: 67.8,
          tempmax: 77.5
        }, {
          datetime: "2022-11-30",
          tempmin: 64.3,
          temp: 68.5,
          tempmax: 78.4
        }, {
          datetime: "2022-12-01",
          tempmin: 64.1,
          temp: 72,
          tempmax: 82.5
        }],
      })
      i = 0
      return
    }

    fetch(`https://weather.visualcrossing.com/VisualCrossingWebServices/rest/services/timeline/${lat},${lng}/${dataInicial}/${dataFinal}?unitGroup=us&key=3HRNW8DH3UCLBY3XJ2N3XT2EX&contentType=json`, {
        "method": "GET",
        "headers": {}
    })
    .then(response => {
    if (response.ok) {
      return response.json()
    }
      throw response
    })
    .then(response => {
      plotarVisualCrossing(response)
    })
    .catch((errorResponse) => {
    if (errorResponse.text) {
        errorResponse.text().then( errorMessage => {
            console.log(errorMessage)
        })
    } else {
        console.log("Erro maluco") 
    }
    })
  }

  /*
  =======
  ALERTAS
  =======
  */
  primeiraChamada = true
  function chamarGrafico(valores, posicao) {
    if (primeiraChamada) {
      primeiraChamada = false
      firstVal = valores
      return
    }
    if (posicao == "primeiro") {
      valoresAtuais = firstVal
      firstVal = valores
    } else {
      valoresAtuais = valores
    }

    metrica = firstVal[1][4]
    if (!(metrica == null || valoresAtuais[1][4] == null)) {
      metricaComparativa = (27 - valoresAtuais[1][4]) * 1.5
      if (metrica <= (10 - (metricaComparativa))) {
        alertar("PERIGO", "baixa demais", metrica, "temperatura")
      } else if (metrica <= (25 - (metricaComparativa))) {
        alertar("ALERTA", "baixa demais", metrica, "temperatura")
      } else if (metrica >= (80 - (metricaComparativa))) {
        alertar("PERIGO", "elevada", metrica, "temperatura")
      } else if (metrica >= (70 - (metricaComparativa))) {
        alertar("ALERTA", "elevada", metrica, "temperatura")
      } else {
        console.log("Alerta não acionado")
      }
    } else {
      console.log("Alertas desabilitados - Sem CPU Core de hoje")
    }
  }

  function alertar(frase, intensidade, metrica, tipo) {
    if (tipo == "temperatura") {
      desc = `A temperatura da CPU do Totem ${carregarTotem} está ficando ${intensidade}`
      valor = `CPU: ${metrica} °C`
    } else if (tipo == "coordenadas") {
      desc = `As coordenadas do Totem ${carregarTotem} apresentam uma variação alta`
      valor = `Variação: ${metrica}m`
    }
    tempoTimeout += 3000
    setTimeout(() => {
      Swal.fire(frase, `${desc}!<br>${valor}`, "warning")
    }, tempoTimeout)
    alertarPipefy(frase, desc, valor)
  }

  function alertarPipefy(frase, descricao, valor) {
    fetch('https://api.pipefy.com/graphql', {
      method: 'POST',
      headers: {
        accept: 'application/json',
        Authorization: 'Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzUxMiJ9.eyJ1c2VyIjp7ImlkIjozMDIxNDc5MDEsImVtYWlsIjoiZWtyYW4uY29udGF0b0BnbWFpbC5jb20iLCJhcHBsaWNhdGlvbiI6MzAwMjAyMTU3fX0.VGdCGMvgQ2bYrUL_YKLK7zO99GBuEcVR9ADkNOjcuiFqh7KgjfsrLqEj86kbg0SgJMZ-J0smfL7Qepn0NltFCg',
        'content-type': 'application/json'
      },
      body: JSON.stringify({
        query: `mutation {createCard(input: {pipe_id:302731204,title:"Card",fields_attributes:[{field_id: "nome_do_colaborador", field_value: "${sessionStorage.NOME_EMPRESA}"},{field_id: "cargo", field_value: "${frase}:\r\n${descricao}\r\nMomento do alerta:\r\n${new Date().getDate()}/${(new Date().getMonth() + 1)}/${new Date().getFullYear()} às ${new Date().getHours()}:${new Date().getMinutes()}"},{field_id: "m_tricas", field_value:"${valor}"}],}) {card {title}}}`,
      })
    })
    .then(response => response.json())
    .then(response => console.log(`Alerta enviado com sucesso ao Pipefy! \r\n ${JSON.stringify(response)}`))
    .catch(err => console.error(`Erro no POST do Pipefy \r\n ${JSON.stringify(err)}`))
  }
  
  /*
  ==================
  FETCH DE VARIAÇÕES
  ==================
  */

  fetch(`/medidas/variacao-cords`, {
    method: "GET"
  }).then(function (response) {
    if (response.ok) {
      response.json().then(function (resposta) {
        organizarVariacoes(resposta)
      })
    }
  })

  function organizarVariacoes(resposta) {
    variacoesDatas = []
    variacoesDados = []

    // Pegando apenas os dados de 5 dias mais recentes
    for (i = 0; i < resposta.length; i++) {
      colocar = true
      for (f = 0; f < variacoesDatas.length; f++) {
        if (resposta[i].dia == variacoesDatas[f]) {
          colocar = false
        }
      }
      if (colocar && variacoesDatas.length < 5) {
        variacoesDatas.push(resposta[i].dia)
      }
    }
    
    for (i = 0; i < resposta.length; i++) {
      for (f = 0; f < variacoesDatas.length; f++) {
        if (resposta[i].dia == variacoesDatas[f]) {
          variacoesDados.push(resposta[i])
        }
      }
    }

    // Ordenando por fkTotem

    variacoesDadosNovos = []

    for (i = 0; i < variacoesDados.length; i++) {
      colocar = true
      for (f = 0; f < variacoesDadosNovos.length; f++) {
        if (variacoesDados[i].fkTotem == variacoesDadosNovos[f][0]) {
          colocar = false
        }
      }
      if (colocar && variacoesDadosNovos.length < 5) {
        variacoesDadosNovos.push([variacoesDados[i].fkTotem, []])
      }
    }
    
    for (i = 0; i < variacoesDados.length; i++) {
      for (f = 0; f < variacoesDadosNovos.length; f++) {
        if (variacoesDados[i].fkTotem == variacoesDadosNovos[f][0]) {
          variacoesDadosNovos[f][1].push(variacoesDados[i])
        }
      }
    }

    variacoesDadosNovos = variacoesDadosNovos.reverse()

    if (carregarTotem != "totens") {
      for (i = 0; i < variacoesDadosNovos.length; i++) {
        if (variacoesDadosNovos[i][0] == carregarTotem) {
          variacoesDadosNovos = [variacoesDadosNovos[i]]
        }
      }
    }

    console.log(variacoesDadosNovos)

    for (i = 0; i < variacoesDadosNovos.length; i++) {

      graficoC = `c${variacoesDadosNovos[i][0]}`
      graficoP = `p${variacoesDadosNovos[i][0]}`
      
      paginaMaior.innerHTML +=
      `
        <div class="row">
          <div class="col-lg-6 col-md-12">
            <div class="card card-tasks">
              <div style="display: flex; align-items: center; justify-content: center; flex-direction: column; height:100%; width:100%">
                <span style="color: white; margin-top: 5%;">Totem ${variacoesDadosNovos[i][0]-49999}</span>
                <span style="font-size: 200%; color: white; display: flex;">Coordenadas <img src="./assets/img/letter_i_PNG11.png" width="25px" height="25px" style="margin-left: 10px; margin-top: 8px;"></span>
                <span style="color: white;">Gráfico de Variação</span>
                <div style="padding: 2%; height:95%; width:95%;">
                  <canvas id="${graficoC}" style="position: relative; height:100%; width:100%;"></canvas>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-6 col-md-12">
            <div class="card card-tasks">
              <div style="display: flex; align-items: center; justify-content: center; flex-direction: column; height:100%; width:100%">
                <span style="color: white; margin-top: 5%;">Totem ${variacoesDadosNovos[i][0]-49999}</span>
                <span style="font-size: 200%; color: white; display: flex;">Precisão da Coleta <img src="./assets/img/letter_i_PNG11.png" width="25px" height="25px" style="margin-left: 10px; margin-top: 8px;"></span>
                <span style="color: white;">Gráfico de Variação</span>
                <div style="padding: 20px; height:95%; width:95%;">
                  <canvas id="${graficoP}" style="position: relative; height:100%; width:100%;"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>
      `

      dadosGraficosMalucos = []
      for (f = 0; f < variacoesDadosNovos[i][1].length; f++) {
        dadosGraficosMalucos.push([[variacoesDadosNovos[i][1][f].dia]])
      }

      // window[graficoC].style.backgroundColor = 'red'
      // Chart.defaults.color = '#fff'
      // new Chart(
      //   window[graficoC],
      //   {
      //       type: 'line',
      //       data:
      //       {
      //           labels: variacoesDadosNovos[i][1].dia,
      //           datasets: [1]
      //       },
      //       options: {}
      //   }
      // )
    }

    /*
    =======================
    VARIAÇÃO DE COORDENADAS
    =======================
    */
    
    /*
    ==============================
    VARIAÇÃO DE PRECISÃO DA COLETA
    ==============================
    */
    
  }
  
</script>